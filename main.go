// GeoIP generator
//
// Before running this file, the GeoIP database must be downloaded and present.
// To download GeoIP database: https://dev.maxmind.com/geoip/geoip2/geolite2/
// Inside you will find block files for IPv4 and IPv6 and country code mapping.
package main

import (
	"encoding/csv"
	"flag"
	"fmt"
	"io/ioutil"
	"os"
	"strings"

	"github.com/golang/protobuf/proto"
	"v2ray.com/core/app/router"
	"v2ray.com/core/common"
	"v2ray.com/core/infra/conf"
)

var (
	countryCodeFile = flag.String("country", "", "Path to the country code file")
	ipv4File        = flag.String("ipv4", "", "Path to the IPv4 block file")
	ipv6File        = flag.String("ipv6", "", "Path to the IPv6 block file")
)

func getCountryCodeMap() (map[string]string, error) {
	countryCodeReader, err := os.Open(*countryCodeFile)
	if err != nil {
		return nil, err
	}
	defer countryCodeReader.Close()

	m := make(map[string]string)
	reader := csv.NewReader(countryCodeReader)
	lines, err := reader.ReadAll()
	if err != nil {
		return nil, err
	}
	for _, line := range lines[1:] {
		id := line[0]
		countryCode := line[4]
		if len(countryCode) == 0 {
			continue
		}
		m[id] = strings.ToUpper(countryCode)
	}
	return m, nil
}

func getCidrPerCountry(file string, m map[string]string, list map[string][]*router.CIDR) error {
	fileReader, err := os.Open(file)
	if err != nil {
		return err
	}
	defer fileReader.Close()

	reader := csv.NewReader(fileReader)
	lines, err := reader.ReadAll()
	if err != nil {
		return err
	}
	for _, line := range lines[1:] {
		cidrStr := line[0]
		countryId := line[1]
		if countryCode, found := m[countryId]; found {
			cidr, err := conf.ParseIP(cidrStr)
			if err != nil {
				return err
			}
			cidrs := append(list[countryCode], cidr)
			list[countryCode] = cidrs
		}
	}
	return nil
}

func main() {
	flag.Parse()

	ccMap, err := getCountryCodeMap()
	if err != nil {
		fmt.Println("Error reading country code map:", err)
		return
	}

	cidrList := make(map[string][]*router.CIDR)
	if err := getCidrPerCountry(*ipv4File, ccMap, cidrList); err != nil {
		fmt.Println("Error loading IPv4 file:", err)
		return
	}
	if err := getCidrPerCountry(*ipv6File, ccMap, cidrList); err != nil {
		fmt.Println("Error loading IPv6 file:", err)
		return
	}

	geoIPList := new(router.GeoIPList)
	for cc, cidr := range cidrList {
		geoIPList.Entry = append(geoIPList.Entry, &router.GeoIP{
			CountryCode: cc,
			Cidr:        cidr,
		})
	}

	geoIPList.Entry = appendByIpKindMap(geoIPList.Entry)
	geoIPBytes, err := proto.Marshal(geoIPList)
	if err != nil {
		fmt.Println("Error marshalling geoip list:", err)
	}

	if err := ioutil.WriteFile("geoip.dat", geoIPBytes, 0777); err != nil {
		fmt.Println("Error writing geoip to file:", err)
	}
}

var ipKindMap = map[string][]string{
	"PRIVATE": {
		"0.0.0.0/8",
		"10.0.0.0/8",
		"100.64.0.0/10",
		"127.0.0.0/8",
		"169.254.0.0/16",
		"172.16.0.0/12",
		"192.0.0.0/24",
		"192.0.2.0/24",
		"192.88.99.0/24",
		"192.168.0.0/16",
		"198.18.0.0/15",
		"198.51.100.0/24",
		"203.0.113.0/24",
		"224.0.0.0/4",
		"240.0.0.0/4",
		"255.255.255.255/32",
		"::1/128",
		"fc00::/7",
		"fe80::/10",
	},
	"DIRECT": {
		// DNS_SERVER_DIRECT_RULE
		"223.5.5.5",
		"223.6.6.6",
		"114.114.114.114",
		"114.114.115.115",
		"119.29.29.29",
	},
	"PROXY": {
		// VPS_IP_DIRECT_RULE
		// aliyun sz
		"112.74.16.233",
		// bwg yuanmomo
		"104.224.172.179",
		// hostmem
		"154.81.3.175",
		// buyvm
		"209.141.59.78",
		// hk-aliyun
		"47.89.52.95",
		// kvm-virmarch
		"107.175.24.169",
		// racknerd
		"173.82.232.131",
		// cloudcone
		"173.82.52.79",
		// amazon ip range
		"3.0.0.0/15",
		"3.5.0.0/20",
		"3.5.16.0/21",
		"3.5.128.0/22",
		"3.5.132.0/23",
		"3.5.208.0/22",
		"3.5.212.0/23",
		"3.6.0.0/15",
		"3.8.0.0/13",
		"3.16.0.0/13",
		"3.24.0.0/14",
		"3.32.0.0/16",
		"3.34.0.0/15",
		"3.80.0.0/12",
		"3.96.0.0/15",
		"3.101.0.0/16",
		"3.104.0.0/14",
		"3.112.0.0/14",
		"3.120.0.0/13",
		"3.128.0.0/12",
		"3.208.0.0/12",
		"3.224.0.0/12",
		"3.248.0.0/13",
		"13.32.0.0/15",
		"13.35.0.0/16",
		"13.48.0.0/15",
		"13.52.0.0/14",
		"13.56.0.0/14",
		"13.112.0.0/14",
		"13.124.0.0/14",
		"13.208.0.0/14",
		"13.224.0.0/12",
		"13.244.0.0/15",
		"13.248.0.0/18",
		"13.248.96.0/21",
		"13.248.104.0/22",
		"13.248.108.0/23",
		"13.248.111.0/24",
		"13.248.112.0/21",
		"13.248.120.0/22",
		"13.248.124.0/24",
		"13.248.127.0/24",
		"13.248.128.0/17",
		"13.249.0.0/16",
		"13.250.0.0/15",
		"15.164.0.0/15",
		"15.177.0.0/18",
		"15.177.64.0/20",
		"15.177.80.0/21",
		"15.177.88.0/23",
		"15.177.91.0/24",
		"15.185.0.0/16",
		"15.188.0.0/16",
		"15.193.0.0/19",
		"15.197.0.0/23",
		"15.197.2.0/24",
		"15.197.4.0/22",
		"15.200.0.0/16",
		"15.206.0.0/15",
		"15.221.0.0/23",
		"15.221.4.0/23",
		"15.221.8.0/21",
		"15.221.16.0/20",
		"15.222.0.0/15",
		"15.230.18.0/24",
		"15.230.21.0/24",
		"15.230.22.0/23",
		"15.230.24.0/21",
		"15.230.32.0/24",
		"15.230.35.0/24",
		"15.236.0.0/15",
		"18.130.0.0/16",
		"18.132.0.0/14",
		"18.136.0.0/16",
		"18.138.0.0/15",
		"18.140.0.0/14",
		"18.144.0.0/15",
		"18.153.0.0/16",
		"18.156.0.0/14",
		"18.162.0.0/15",
		"18.166.0.0/15",
		"18.175.0.0/16",
		"18.176.0.0/13",
		"18.184.0.0/15",
		"18.188.0.0/14",
		"18.192.0.0/11",
		"18.224.0.0/13",
		"18.232.0.0/14",
		"18.236.0.0/15",
		"18.246.0.0/16",
		"18.252.0.0/15",
		"23.20.0.0/14",
		"27.0.0.0/22",
		"34.192.0.0/10",
		"35.153.0.0/16",
		"35.154.0.0/15",
		"35.156.0.0/14",
		"35.160.0.0/12",
		"35.176.0.0/13",
		"43.250.192.0/23",
		"44.192.0.0/10",
		"46.51.128.0/18",
		"46.51.192.0/20",
		"46.51.216.0/21",
		"46.51.224.0/19",
		"46.137.0.0/16",
		"50.16.0.0/14",
		"50.112.0.0/16",
		"52.0.0.0/11",
		"52.32.0.0/13",
		"52.40.0.0/14",
		"52.44.0.0/15",
		"52.46.0.0/17",
		"52.46.128.0/19",
		"52.46.164.0/22",
		"52.46.168.0/21",
		"52.46.176.0/21",
		"52.46.184.0/22",
		"52.46.192.0/19",
		"52.46.224.0/20",
		"52.46.240.0/22",
		"52.46.249.0/24",
		"52.46.250.0/23",
		"52.46.252.0/22",
		"52.47.0.0/16",
		"52.48.0.0/12",
		"52.64.0.0/12",
		"52.80.0.0/15",
		"52.82.0.0/17",
		"52.82.128.0/19",
		"52.82.160.0/21",
		"52.82.168.0/24",
		"52.82.169.0/27",
		"52.82.176.0/21",
		"52.82.184.0/23",
		"52.82.187.0/24",
		"52.82.188.0/22",
		"52.82.192.0/18",
		"52.83.0.0/16",
		"52.84.0.0/14",
		"52.88.0.0/14",
		"52.92.0.0/19",
		"52.92.32.0/22",
		"52.92.40.0/21",
		"52.92.48.0/22",
		"52.92.60.0/22",
		"52.92.72.0/21",
		"52.92.88.0/22",
		"52.92.252.0/22",
		"52.93.0.0/22",
		"52.93.4.0/23",
		"52.93.8.0/22",
		"52.93.12.12/31",
		"52.93.14.18/31",
		"52.93.16.0/23",
		"52.93.18.178/31",
		"52.93.19.236/31",
		"52.93.20.0/24",
		"52.93.21.14/31",
		"52.93.34.56/31",
		"52.93.35.212/31",
		"52.93.37.222/31",
		"52.93.38.0/24",
		"52.93.43.0/24",
		"52.93.48.0/24",
		"52.93.51.28/31",
		"52.93.56.0/23",
		"52.93.59.0/24",
		"52.93.60.0/24",
		"52.93.62.0/23",
		"52.93.64.0/24",
		"52.93.67.0/24",
		"52.93.69.0/24",
		"52.93.73.0/26",
		"52.93.75.0/24",
		"52.93.76.0/24",
		"52.93.78.0/24",
		"52.93.80.0/23",
		"52.93.96.0/22",
		"52.93.112.0/24",
		"52.93.120.178/32",
		"52.93.122.131/32",
		"52.93.126.76/32",
		"52.93.126.132/30",
		"52.93.126.136/30",
		"52.93.126.144/30",
		"52.93.137.0/24",
		"52.93.138.252/31",
		"52.93.139.252/31",
		"52.93.146.5/32",
		"52.93.149.0/24",
		"52.93.150.0/23",
		"52.93.153.80/32",
		"52.93.156.0/22",
		"52.93.236.0/23",
		"52.93.245.0/24",
		"52.93.247.0/25",
		"52.93.248.0/22",
		"52.93.254.0/24",
		"52.94.0.0/20",
		"52.94.16.0/23",
		"52.94.19.0/24",
		"52.94.20.0/24",
		"52.94.22.0/23",
		"52.94.24.0/22",
		"52.94.28.0/23",
		"52.94.30.0/24",
		"52.94.32.0/19",
		"52.94.64.0/22",
		"52.94.68.0/23",
		"52.94.72.0/21",
		"52.94.80.0/20",
		"52.94.96.0/19",
		"52.94.192.0/22",
		"52.94.196.0/23",
		"52.94.198.0/25",
		"52.94.198.128/27",
		"52.94.199.0/24",
		"52.94.200.0/24",
		"52.94.201.0/26",
		"52.94.204.0/22",
		"52.94.208.0/20",
		"52.94.224.0/20",
		"52.94.240.0/21",
		"52.94.248.0/25",
		"52.94.248.128/26",
		"52.94.248.192/27",
		"52.94.248.224/28",
		"52.94.249.32/28",
		"52.94.249.64/26",
		"52.94.249.128/26",
		"52.94.252.0/22",
		"52.95.0.0/20",
		"52.95.16.0/21",
		"52.95.24.0/22",
		"52.95.28.0/24",
		"52.95.29.0/26",
		"52.95.30.0/23",
		"52.95.34.0/23",
		"52.95.36.0/22",
		"52.95.40.0/23",
		"52.95.42.0/24",
		"52.95.48.0/20",
		"52.95.64.0/18",
		"52.95.128.0/21",
		"52.95.136.0/23",
		"52.95.138.0/24",
		"52.95.142.0/23",
		"52.95.144.0/22",
		"52.95.148.0/23",
		"52.95.150.0/24",
		"52.95.154.0/23",
		"52.95.156.0/22",
		"52.95.160.0/20",
		"52.95.176.0/24",
		"52.95.192.0/20",
		"52.95.208.0/21",
		"52.95.216.0/22",
		"52.95.225.0/24",
		"52.95.226.0/23",
		"52.95.228.0/22",
		"52.95.239.0/24",
		"52.95.240.0/21",
		"52.95.248.0/22",
		"52.95.252.0/23",
		"52.95.254.0/24",
		"52.95.255.0/25",
		"52.95.255.128/27",
		"52.119.160.0/19",
		"52.119.192.0/21",
		"52.119.205.0/24",
		"52.119.206.0/23",
		"52.119.208.0/20",
		"52.119.224.0/20",
		"52.119.240.0/21",
		"52.119.248.0/23",
		"52.119.252.0/22",
		"52.124.128.0/17",
		"52.144.192.0/24",
		"52.144.193.0/25",
		"52.144.193.128/26",
		"52.144.194.0/24",
		"52.144.195.0/26",
		"52.144.196.192/26",
		"52.144.197.128/25",
		"52.144.199.128/26",
		"52.144.200.64/26",
		"52.144.200.128/26",
		"52.144.201.128/26",
		"52.144.208.64/26",
		"52.144.208.128/25",
		"52.144.209.0/24",
		"52.144.210.0/24",
		"52.144.211.0/25",
		"52.144.211.128/26",
		"52.144.211.192/29",
		"52.144.211.200/30",
		"52.144.212.64/26",
		"52.144.212.192/26",
		"52.144.213.64/26",
		"52.144.215.0/30",
		"52.144.215.192/29",
		"52.144.215.200/30",
		"52.144.216.0/29",
		"52.144.216.8/30",
		"52.144.218.0/25",
		"52.144.224.64/26",
		"52.144.224.128/25",
		"52.144.225.0/25",
		"52.144.225.128/26",
		"52.144.227.64/26",
		"52.144.227.192/26",
		"52.144.228.64/26",
		"52.144.228.128/25",
		"52.144.229.0/25",
		"52.144.230.0/26",
		"52.144.231.64/26",
		"52.192.0.0/12",
		"52.208.0.0/13",
		"52.216.0.0/15",
		"52.218.0.0/16",
		"52.219.0.0/19",
		"52.219.32.0/20",
		"52.219.48.0/22",
		"52.219.56.0/21",
		"52.219.64.0/21",
		"52.219.72.0/22",
		"52.219.80.0/20",
		"52.219.96.0/19",
		"52.219.128.0/21",
		"52.219.136.0/22",
		"52.219.140.0/24",
		"52.220.0.0/15",
		"52.222.0.0/16",
		"54.64.0.0/11",
		"54.144.0.0/12",
		"54.160.0.0/11",
		"54.192.0.0/12",
		"54.208.0.0/13",
		"54.216.0.0/14",
		"54.220.0.0/15",
		"54.222.0.0/19",
		"54.222.32.0/21",
		"54.222.48.0/21",
		"54.222.57.0/24",
		"54.222.58.0/28",
		"54.222.58.32/27",
		"54.222.59.0/24",
		"54.222.64.0/22",
		"54.222.128.0/17",
		"54.223.0.0/16",
		"54.224.0.0/14",
		"54.228.0.0/15",
		"54.230.0.0/16",
		"54.231.0.0/17",
		"54.231.128.0/18",
		"54.231.192.0/20",
		"54.231.232.0/21",
		"54.231.244.0/22",
		"54.231.248.0/22",
		"54.231.252.0/24",
		"54.232.0.0/14",
		"54.236.0.0/15",
		"54.238.0.0/16",
		"54.239.0.0/24",
		"54.239.1.0/27",
		"54.239.1.48/28",
		"54.239.1.64/28",
		"54.239.1.81/32",
		"54.239.1.82/31",
		"54.239.1.96/27",
		"54.239.1.128/28",
		"54.239.2.0/23",
		"54.239.4.0/22",
		"54.239.8.0/21",
		"54.239.16.0/20",
		"54.239.32.0/21",
		"54.239.40.152/29",
		"54.239.48.0/20",
		"54.239.64.0/21",
		"54.239.96.0/24",
		"54.239.98.0/23",
		"54.239.100.0/23",
		"54.239.104.0/21",
		"54.239.112.0/23",
		"54.239.115.0/25",
		"54.239.116.0/22",
		"54.239.120.0/21",
		"54.239.128.0/18",
		"54.239.192.0/19",
		"54.240.17.0/24",
		"54.240.128.0/18",
		"54.240.192.0/21",
		"54.240.200.0/24",
		"54.240.202.0/23",
		"54.240.204.0/22",
		"54.240.208.0/20",
		"54.240.225.0/24",
		"54.240.226.0/23",
		"54.240.228.0/22",
		"54.240.232.0/22",
		"54.240.241.0/24",
		"54.240.244.0/22",
		"54.240.248.0/21",
		"54.241.0.0/16",
		"54.242.0.0/15",
		"54.244.0.0/14",
		"54.248.0.0/13",
		"63.32.0.0/14",
		"64.252.64.0/18",
		"64.252.128.0/18",
		"67.202.0.0/18",
		"68.79.0.0/18",
		"70.132.0.0/18",
		"70.224.192.0/18",
		"71.152.0.0/17",
		"72.21.192.0/19",
		"72.44.32.0/19",
		"75.2.0.0/17",
		"75.101.128.0/17",
		"76.223.0.0/17",
		"79.125.0.0/17",
		"87.238.80.0/21",
		"96.127.0.0/17",
		"99.77.128.0/21",
		"99.77.136.0/23",
		"99.77.139.0/24",
		"99.77.140.0/22",
		"99.77.144.0/23",
		"99.77.147.0/24",
		"99.77.148.0/22",
		"99.77.152.0/22",
		"99.77.156.0/23",
		"99.77.158.0/24",
		"99.77.160.0/23",
		"99.77.186.0/23",
		"99.77.188.0/22",
		"99.77.247.0/24",
		"99.77.250.0/24",
		"99.77.253.0/24",
		"99.77.254.0/24",
		"99.78.128.0/19",
		"99.78.160.0/21",
		"99.78.168.0/22",
		"99.78.172.0/24",
		"99.78.176.0/20",
		"99.78.192.0/21",
		"99.78.208.0/20",
		"99.79.0.0/16",
		"99.80.0.0/15",
		"99.82.128.0/18",
		"99.83.64.0/21",
		"99.83.128.0/17",
		"99.84.0.0/16",
		"99.86.0.0/16",
		"100.20.0.0/14",
		"100.24.0.0/13",
		"103.4.8.0/21",
		"103.8.172.0/22",
		"103.246.148.0/22",
		"107.20.0.0/14",
		"108.128.0.0/13",
		"108.166.224.0/19",
		"108.175.48.0/21",
		"122.248.192.0/18",
		"130.176.0.0/16",
		"140.179.0.0/16",
		"143.204.0.0/16",
		"144.220.0.0/16",
		"150.222.2.0/24",
		"150.222.5.0/24",
		"150.222.7.0/24",
		"150.222.10.0/24",
		"150.222.11.0/31",
		"150.222.12.0/23",
		"150.222.66.0/23",
		"150.222.69.0/24",
		"150.222.70.0/23",
		"150.222.72.0/21",
		"150.222.80.0/22",
		"150.222.84.0/23",
		"150.222.87.0/24",
		"150.222.88.0/21",
		"150.222.96.0/22",
		"150.222.100.0/23",
		"150.222.102.0/24",
		"150.222.104.0/23",
		"150.222.106.0/24",
		"150.222.108.0/23",
		"150.222.110.0/24",
		"150.222.112.0/24",
		"150.222.114.0/23",
		"150.222.116.0/22",
		"150.222.121.0/24",
		"150.222.129.112/28",
		"150.222.129.128/29",
		"150.222.129.136/30",
		"150.222.129.140/31",
		"150.222.133.0/24",
		"150.222.134.0/23",
		"150.222.136.0/24",
		"150.222.138.0/24",
		"150.222.140.0/22",
		"150.222.176.0/22",
		"150.222.180.0/24",
		"150.222.196.0/24",
		"150.222.199.0/25",
		"150.222.202.0/24",
		"150.222.204.0/22",
		"150.222.208.64/27",
		"150.222.208.96/31",
		"150.222.210.0/24",
		"150.222.214.0/23",
		"150.222.218.0/24",
		"150.222.220.0/22",
		"150.222.224.0/24",
		"150.222.227.0/24",
		"150.222.228.0/24",
		"150.222.233.0/24",
		"150.222.234.0/23",
		"150.222.236.0/23",
		"150.222.239.0/24",
		"150.222.242.84/31",
		"150.222.242.214/31",
		"150.222.242.227/32",
		"150.222.242.229/32",
		"150.222.242.231/32",
		"150.222.242.233/32",
		"150.222.243.20/30",
		"150.222.243.24/29",
		"150.222.243.48/31",
		"150.222.245.122/31",
		"157.175.0.0/16",
		"160.1.0.0/16",
		"161.189.0.0/16",
		"162.213.232.0/22",
		"162.250.236.0/22",
		"172.96.97.0/24",
		"172.96.98.0/24",
		"174.129.0.0/16",
		"175.41.128.0/17",
		"176.32.64.0/19",
		"176.32.96.0/20",
		"176.32.112.0/21",
		"176.32.120.0/22",
		"176.32.124.128/25",
		"176.32.125.0/24",
		"176.34.0.0/16",
		"177.71.128.0/17",
		"177.72.240.0/21",
		"178.236.0.0/20",
		"184.72.0.0/15",
		"184.169.128.0/17",
		"185.48.120.0/22",
		"185.143.16.0/24",
		"199.127.232.0/22",
		"203.83.220.0/22",
		"204.236.128.0/17",
		"204.246.160.0/19",
		"205.251.192.0/19",
		"205.251.224.0/20",
		"205.251.240.0/21",
		"205.251.248.0/22",
		"205.251.252.0/23",
		"205.251.254.0/24",
		"207.171.160.0/19",
		"208.86.88.0/22",
		"216.137.32.0/19",
		"216.182.224.0/20",


		// DNS server
		"8.8.8.8",
		"8.8.4.4",
		"1.1.1.1",
	},
}

func appendByIpKindMap(geoIPList []*router.GeoIP) []*router.GeoIP{
	for k, v := range ipKindMap {
		cidr := make([]*router.CIDR, 0, 16)
		for _, ip := range v {
			c, err := conf.ParseIP(ip)
			common.Must(err)
			cidr = append(cidr, c)
		}
		geoIP := &router.GeoIP{
			CountryCode: k,
			Cidr:        cidr,
		}
		geoIPList = append(geoIPList, geoIP)
	}
	return  geoIPList
}
